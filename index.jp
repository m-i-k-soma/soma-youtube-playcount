import "dotenv/config";
import fetch from "node-fetch";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

const YOUTUBE_API_KEY = process.env.YOUTUBE_API_KEY;

async function fetchVideoStats(videoId) {
  const url = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${YOUTUBE_API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.items?.[0]?.statistics?.viewCount || null;
}

async function main() {
  // 1. Supabaseã‹ã‚‰å‹•ç”»ãƒªã‚¹ãƒˆå–å¾—
  const { data: videos, error } = await supabase.from("videos").select("*");
  if (error) {
    console.error("å‹•ç”»å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    return;
  }

  console.log("ğŸ¬ ç™»éŒ²æ¸ˆã¿å‹•ç”»:", videos);

  // 2. å„å‹•ç”»ã®å†ç”Ÿæ•°ã‚’å–å¾—ã—ã¦ä¿å­˜
  for (const video of videos) {
    const views = await fetchVideoStats(video.id);
    console.log(`â–¶ ${video.title}: ${views} views`);

    // 3. Supabaseã«ãƒ­ã‚°ã‚’è¿½åŠ 
    const { error: insertError } = await supabase.from("video_logs").insert([
      {
        video_id: video.id,
        views: views,
        created_at: new Date().toISOString(),
      },
    ]);

    if (insertError) {
      console.error("Insert error:", insertError);
    }
  }
}

main();

