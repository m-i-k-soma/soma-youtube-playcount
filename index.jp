import "dotenv/config";
import fetch from "node-fetch";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

const YOUTUBE_API_KEY = process.env.YOUTUBE_API_KEY;

async function fetchVideoStats(videoId) {
  const url = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${YOUTUBE_API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.items?.[0]?.statistics?.viewCount || null;
}

async function main() {
  // 1. Supabaseから動画リスト取得
  const { data: videos, error } = await supabase.from("videos").select("*");
  if (error) {
    console.error("動画取得エラー:", error);
    return;
  }

  console.log("🎬 登録済み動画:", videos);

  // 2. 各動画の再生数を取得して保存
  for (const video of videos) {
    const views = await fetchVideoStats(video.id);
    console.log(`▶ ${video.title}: ${views} views`);

    // 3. Supabaseにログを追加
    const { error: insertError } = await supabase.from("video_logs").insert([
      {
        video_id: video.id,
        views: views,
        created_at: new Date().toISOString(),
      },
    ]);

    if (insertError) {
      console.error("Insert error:", insertError);
    }
  }
}

main();

